2019/4/5

`后坐力`√

不同枪械提供不同的横纵后坐力的值。后坐力的值也都是区间随机的。只不过每个枪械提供的后坐力范围不同而已。

`优化客户端枪械体验`√

①当换子弹动画结束之后我们才可以进行射击。

②当子弹库中数量等于0的时候就不要继续换子弹了。

③当枪没有子弹了的时候，发出空弹的声音

`敌人AI`

①关于手上的武器，我们首先固定武器为AK47，创建单独属于敌人的武器，以及单独术语敌人的子弹。

②现在可以按键发射一个子弹打到玩家的脚下了。

2019/4/6

`地图`√

①首先我们应该设定好地图上的一些该有的建筑物

②然后我们应该导出一个01地图，导出01地图的时候，我们只需要导出静态可走以及不可走的地方即可。我们将地形的高点设置为不可走。将静态障碍物设置为不可走。
静态障碍物我们得到其Mesh的顶点结构，加上他的位子就是不可走的地方。

③暂时我准备先创建几个敌人出来先看看效果

`敌人AI的创建`

①首先我们将处理好的01地图，导入到MapLoad.Py中，然后对其进行分析。创建出敌人AI的逻辑。

2019/4/7

`敌人AI的创建`√

①我们现在创建账号的同时，我们创建出了5个敌人AI。然后把这5个敌人AI的信息随着注册的同时，放入数据库。

②当登陆游戏的时候，我们创建角色并查询剩余敌人的数量

③登陆游戏之后，我们要创建出敌人，那么就要查询剩余敌人的Id都是什么，再根据剩余Id创建出敌人才行。

`目前为止的服务器逻辑`√

①注册账号，当注册账号的时候，我们创建出一个玩家，然后同时创建出五个AI敌人出来，同时将他们都插入到数据库中。

②登陆账号：
1.当登陆账号的时候，我们得到账号的字符串、剩余敌人数量，以及玩家Init状态的字典。
2.当进入游戏场景的时候，我们Init玩家的状态，同时查询剩余玩家的数量以及对应的IdArray。然后创建出敌人，并且将他们的Id赋值过去。
3.敌人创建出来的时候，去服务器上查询他们的信息。比如位子和剩余血量等。相当于要Init敌人。

③保存更新角色：
1.我们每一秒发送到服务器一个信息。然后更新角色的血量，枪械子弹数量等。

`预计服务器剩余任务`

①保存敌人信息，也是每一秒保存敌人的信息，当敌人的血量值小于等于0的时候，将其信息从数据库中删除即可。

②敌人寻路请求，当客户端的敌人发出寻路请求的时候，我们在服务端进行寻路。

2019/4/9

`服务器的Update`√

做了一个本地存储的缓存。
后期可以修改为redis。

`客户端可玩性优化`√

做一个准星动态放大的效果

`服务器`

服务器逻辑暂时不进行修改。

客户端全是问题
①如果取消InitEnemy的活性的话，注册、登陆玩家、保存玩家的逻辑没有问题。

`服务器`

①可能是要把之前的代码全部剔除了。

②简化问题就是，选取适当的技术和方法，让两侧的通信是正确的。即两边的通信各自的接收信息和发送信息的逻辑是正确的。

`客户端发送和接收`

客户端发送：一定是从游戏组件发出的。

客户端接收：？

`服务器发送和接收`

服务器发送：？

服务器接收：？

2019/4/12

`服务器`√

①在服务端，使用select.select对读入进行轮询监听。

①服务器端现在已经有的操作模块为：

1.登录模块（需要返回）

2.注册模块（需要返回）

3.查询玩家信息模块（需要返回）

4.更新玩家信息模块（不需要返回，但是尽量返回一个）

5.查询敌人Id Array模块（需要返回）

6.按照Id查询敌人信息模块（需要返回）

7.按照Id更新敌人信息模块（不需要返回，但是尽量也要返回一个）

`服务器测试模拟`

①写一个简单的服务器窗口，使用select.select，完成两个发送功能：每0.5s发送给客户端一个消息，以及如果有接受到的消息，反馈一个信息。

②写一个简单的Unity接收窗口，使用线程的方式将接受到的信息进行集中处理。

`关于通信`

①无论是服务端还是客户端，我们都需要将接收到的消息分开，可能多条消息重叠在了一起。那么每次处理消息的时候都需要一个关于消息队列的循环。

②我们现在可以使用select.select进行对socket的监控，如果有消息发过来，对发来的消息进行集中处理即可。

③服务器可以主动发送消息也可以被动发送消息，无论怎样发送消息，我们都统一进行处理即可。

`服务器更新`√

将接到的信息分成若干个子信息操作了。

2019/4/13

`服务器和客户端的一个Bug`√


接收到的消息不仅仅可能是单独的一条，还有可能是多条，甚至可能是断档的一条消息。需要做一个伪保存。

`服务器AI`

首先学习一下，什么是简单的服务器AI。

现在的选择应该是AI行为树。具体设计如下：

2019/4/15

`服务器AI`√

修改了下线再上线之后无法寻路的bug

`客户端AI`

将客户端的敌人代码控制器中的代码进行了简单的优化。

将客户端的敌人的Mesh Collider 进行了更新，现在的敌人移动的时候，MeshCollider完全贴合着敌人的模型移动了。

将客户端的Player的Mesh Collider 进行了更新，现在玩家移动的时候，Mesh Collider完全贴合着玩家的模型移动了。

`Bug`

如果当我们正在寻路的时候退出了游戏，那么服务器就会出现问题。

极大的修改了可能出现卡顿的情况的优化。

2019/4/17

`近期需要进行的必要功能实现`

敌人的攻击

`优化了拾起武器和子弹等物品的体验`√

使用了相交球的检测方式，将距离玩家最近的武器设置为可拾取。同时优化了拾取子弹以及血包等物品的体验。

`敌人的子弹`

首先敌人的子弹获取到玩家的位子，然后随机他的子弹落点。同时无限延长子弹的飞行轨迹即可。

`困难点`

碰撞环境，准备搭建游戏环境。搭建好游戏环境之后，将导出一个新的01地图用于寻路和创建敌人。

`问题遗留`

加上Rigdbody好像在服务器端发生了问题。
将玩家的Mesh collider修改为Convex之后，出现了射击问题。

`客户端优化`√

搞定了子弹飞行等简单问题。

2019/4/18

`客户端优化`

添加了看起来算是正确的碰撞（不过没有处理抖动等情况）

2019/4/20

`游戏场景搭建`

将游戏场景搭建完毕。

并且将游戏场景中的静态阻挡物体更新到了服务器上。

`客户端逻辑`

增加了登陆界面的退出游戏按钮

新增加了退出游戏功能

修复一切关于退出游戏功能的Bug。

现在游戏中退出是回到登陆注册页面，然后再退出游戏才会整个退出。

`客户端游戏体验`

增加了枪械缩略图

修改了碰撞不造成伤害的Bug

修改了自己的子弹碰撞自己子弹的Bug

`近期还要完成的功能有`

AI的攻击、玩家死亡逻辑、重新开始游戏逻辑。

`客户端游戏体验`

增加了人物死亡的逻辑（本地死亡，无其他功能）

增加了结束游戏的场景以及音效的选取。

`之后要进行的内容`

首先一定要把结束游戏等逻辑同步到服务器上才行

2019/4/21

`游戏主体功能`

增加了重新开始游戏的功能，同步到服务端等操作都已经搭建完毕了。

增加了结束游戏画面并且增加结束画面的两个按钮，分别是重新游戏以及退出到主界面。

`发现新问题`

我如果在敌人的范围内，敌人就进行攻击，没有进行射线检测。我们应该进行一个射线检测，看看是否有障碍物拦着才行。因为客户端的主动攻击没有产生真正物理层面的射线内容。

`客户端游戏体验`

增加了加载界面

2019/4/22

`客户端游戏体验`

增加了Pkm的基础功能。

`客户端游戏体验问题`

子弹的射出点位子相对靠后。子弹出生的位子应当给予协调。

`敌人AI预准备` 

敌人是否可以看见玩家的逻辑重新修改了一下，现在墙体遮挡的玩家不会被观察到了。

`关于敌人AI的想法`

0.关于安全的情况，敌人安全的情况我们已经做到差不多符合我自己的预期了。剩下的内容，就是处理不安全的情况，以及相互交替的情况。

0.0.当进入不安全的情况的时候，我们的逻辑预想是这样的：

①如果不安全了，那么走路的方式要从走变成跑。

②如果不安全了，那么视野范围应当适当加大。

1.关于敌人视野。敌人如果没有被攻击，视野肯定是相对较近一些的。如果敌人被攻击了或者是敌人观察到了玩家的位子，那么按道理来讲，我们应该适当的加大敌人的视野范围角度和距离。如果敌人已经看到了玩家，那么一定要是LookAt（玩家）的。保持视野角度的跟随。

2.主动攻击，如果敌人在安全的情况下发现了玩家，那么应该告诉服务器终止寻路并且开始攻击玩家。同时清空自己的寻路数组以及目标点。

3.当主动攻击无效的时候（也就是说敌人突然发觉自己没法看见玩家的时候）。我们应当切换走路姿势为跑动，并且应当跟随一下玩家。

4.确定X秒之后，敌人的逻辑从不安全再转换到安全才行。

`服务器Bug`

进行重新游戏的指令的时候，SaveEnemy任然进行了几次，所以导致重新游戏敌人不会再进行寻路。

`服务器Bug修正`

进行重新游戏指指令之前，我们首先将所有的敌人都删除干净，然后再发出重新游戏的指令就OK了。

`关于最终敌人AI的描写`

几种状态：

1.安全状态（不断的切换寻路(服务器控制)和站街模式(服务器控制)）【Safe】

2.能看见玩家的不安全状态(只进行攻击)【Attack】

3.寻找玩家的不安全状态（从能看见玩家到看不见玩家的状态，第一次寻路直接找突然看不见玩家的位子，接下来几次寻找玩家的时候都是跑动姿势的警戒寻路。数秒后回归安全状态）【Find】

4.被动逃跑的不安全状态（被玩家攻击然而看不见玩家的状态，或者是找不见玩家的状态，跑动巡逻的状态）【Run】

`状态改变`

主动攻击玩家：1->2->3->4->数秒之后->1

被动攻击玩家：1->4->数秒之后->1

客户端只提供视野信息和攻击状态的进行。对状态的修改是服务器的责任。

四种状态都已经进行了署名、接下来我们就可以着手开始进行状态修改了。

`发现Bug`

当我们登陆了一个账号之后，退出到了主界面，然后再登陆这个账号的话，我们点重新游戏并没有真正的重新游戏。

原因是我们的InitDict客户端的玩家的InitDict没有更新的原因。

`解决服务器Bug`

当我们登陆了一个账号之后，退出到主界面，没有更新玩家InitDict的问题解决了。

`服务器AI行为`

首先我们从客户端传输到服务器上每个敌人的视野信息了。

如果切换到Attack状态的话，那么我们首先将客户端的敌人设定为攻击状态，然后站着不动攻击玩家，然后清空整个寻路列表。设定此时状态为Danger。

`状态切换`

任何状态（现在只有状态1）到状态2的切换：
客户端要做的事情就是清空寻路列表，开枪，和设定目标点为(-1,-1,-1);
服务端要做的事情就是设定状态为Attack。设定目标点为(-1,-1).清空站街时间为(0.0f)

现在我们的视野信息传递给了服务器上。

任何状态转换到攻击状态的时候，我们服务器要做的事情是切换攻击状态，设定目标点为(-1,-1)，然后设置站街时间为无限时间长度(100000);

服务器上，当敌人从Attack变成Find的时候，寻路一次，Find自动变成Run

`服务器AI`

服务器AI此时已经能够进行1-2-3-4的状态切换了。

服务器AI此时已经能够进行1->2->3->4->1的状态切换了。

`客户端游戏体验优化`

增加了新的天空盒

将子弹发出的位子进行了修改

增加了新的枪口火焰。

新增了击杀特效。

优化了退出游戏和保存游戏等逻辑。

`近期优化内容`

登陆逻辑的优化。

人物穿墙的问题。

敌人被攻击的逻辑。

2019/4/26

`客户端优化问题`

现在采取了一些移动方式的改变。看起来应该能够解决碰撞穿墙的问题。下午继续处理其他问题。

`客户端关键优化`

去掉人物的刚体，为每一种武器的脚本中增肌了一个移动脚本。使用人物控制器的方式改变控制人物的方式。

这样就能够达到预期的目标了。

比较完美的解决了人物撞墙穿墙等问题。

`客户端优化`

修复了Pkm机枪的换子弹以及报错问题。

给武器Pkm增加了枪口火焰，子弹发射的初始位子也是正确的了，同时让枪口朝向尽量正确了。

现在如果不瞄准就无法进行射击了。

`客户端游戏体验优化`

现在可以按键回血了。

回血机制为任何时刻按Z键即可回血。

如果血量不满而且有血包的情况下，提示按键回血。

2019/4/27

`服务器AI控制`

如果我们攻击到了一个Safe的敌人，那么这个敌人向服务器发送一个请求，停止一切行为。然后等待客户端0.3s的时间然后立即设置状态为Find。

`客户端优化`

当敌人处于危险状态的时候，视野范围会变大。

对敌人的子弹威力适当降低，提升游戏体验，如果敌人一枪打到玩家头就死的话游戏体验会降低一个档次。













